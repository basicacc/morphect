name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest
    name: Linux (${{ matrix.compiler }})

    strategy:
      matrix:
        compiler: [gcc-12, gcc-13]
        include:
          - compiler: gcc-12
            cc: gcc-12
            cxx: g++-12
          - compiler: gcc-13
            cc: gcc-13
            cxx: g++-13

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ${{ matrix.cc }} \
          ${{ matrix.cxx }} \
          gcc-12-plugin-dev \
          gcc-13-plugin-dev \
          clang \
          cmake \
          ninja-build

    - name: Configure CMake
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

    - name: Unit Tests
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure -L unit

    - name: Integration Tests
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure -L integration
      continue-on-error: true  # Integration tests may have some platform-specific issues

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-linux-${{ matrix.compiler }}
        path: ${{github.workspace}}/build/Testing/

  build-macos:
    runs-on: macos-latest
    name: macOS (${{ matrix.arch }})

    strategy:
      matrix:
        arch: [arm64, x86_64]
        include:
          - arch: arm64
            cmake_arch: arm64
          - arch: x86_64
            cmake_arch: x86_64

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja llvm

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_OSX_ARCHITECTURES=${{ matrix.cmake_arch }} \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DMORPHECT_BUILD_GIMPLE_PLUGIN=OFF \
          -DMORPHECT_BUILD_IR_OBFUSCATOR=ON \
          -DMORPHECT_BUILD_ASM_OBFUSCATOR=ON \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

    - name: Unit Tests
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure -L unit
      # Only run tests on native architecture
      if: matrix.arch == 'arm64'

    - name: Verify binaries
      run: |
        echo "Checking morphect-ir..."
        file ${{github.workspace}}/build/bin/morphect-ir
        ${{github.workspace}}/build/bin/morphect-ir --help || true
        echo ""
        echo "Checking morphect-asm..."
        file ${{github.workspace}}/build/bin/morphect-asm
        ${{github.workspace}}/build/bin/morphect-asm --help || true

    - name: Integration test
      if: matrix.arch == 'arm64'
      run: |
        # Create test file
        cat > /tmp/test.c << 'EOF'
        #include <stdio.h>
        int add(int a, int b) { return a + b; }
        int main() {
            int result = add(5, 3);
            printf("Result: %d\n", result);
            return (result == 8) ? 0 : 1;
        }
        EOF

        # Generate LLVM IR
        clang -S -emit-llvm -O0 /tmp/test.c -o /tmp/test.ll

        # Obfuscate
        ${{github.workspace}}/build/bin/morphect-ir --mba --probability 1.0 /tmp/test.ll /tmp/obfuscated.ll

        # Compile and run
        /opt/homebrew/opt/llvm/bin/llc /tmp/obfuscated.ll -o /tmp/obfuscated.s || true
        if [ -f /tmp/obfuscated.s ]; then
          clang /tmp/obfuscated.s -o /tmp/test_program
          /tmp/test_program
          echo "Integration test passed!"
        else
          echo "Note: llc compilation skipped (may need architecture-specific flags)"
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-macos-${{ matrix.arch }}
        path: ${{github.workspace}}/build/Testing/

  benchmark:
    runs-on: ubuntu-latest
    needs: build-linux
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 gcc-13-plugin-dev cmake ninja-build

    - name: Configure CMake
      env:
        CC: gcc-13
        CXX: g++-13
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DMORPHECT_BUILD_TESTS=OFF \
          -DMORPHECT_BUILD_BENCHMARKS=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Run Benchmarks
      working-directory: ${{github.workspace}}/build
      run: ./bin/morphect_bench --benchmark_format=json > benchmark_results.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: ${{github.workspace}}/build/benchmark_results.json

  coverage:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 gcc-13-plugin-dev cmake ninja-build lcov

    - name: Configure CMake with coverage
      env:
        CC: gcc-13
        CXX: g++-13
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_C_FLAGS="--coverage" \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build ${{github.workspace}}/build

    - name: Run tests
      working-directory: ${{github.workspace}}/build
      run: ctest --output-on-failure -L unit

    - name: Generate coverage report
      run: |
        lcov --capture --directory ${{github.workspace}}/build \
          --output-file coverage.info \
          --ignore-errors mismatch
        lcov --remove coverage.info '/usr/*' '*/build/_deps/*' \
          --output-file coverage.info \
          --ignore-errors unused
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.info
        fail_ci_if_error: false

  clang-format:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check formatting
      uses: jidicula/clang-format-action@v4.13.0
      with:
        clang-format-version: '17'
        check-path: 'src'
        fallback-style: 'LLVM'
      continue-on-error: true  # Don't fail CI on format issues, just report

  sanitizers:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # Only run UBSan - ASan has test discovery issues with gtest_discover_tests
          - sanitizer: undefined
            static_lib: -static-libubsan

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 gcc-13-plugin-dev cmake ninja-build

    - name: Configure CMake
      env:
        CC: gcc-13
        CXX: g++-13
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} ${{ matrix.static_lib }}" \
          -DCMAKE_C_FLAGS="-fsanitize=${{ matrix.sanitizer }} ${{ matrix.static_lib }}" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }} ${{ matrix.static_lib }}" \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build ${{github.workspace}}/build

    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      working-directory: ${{github.workspace}}/build
      run: ctest --output-on-failure
      env:
        UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
