name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compiler: [gcc-12, gcc-13]
        include:
          - compiler: gcc-12
            cc: gcc-12
            cxx: g++-12
          - compiler: gcc-13
            cc: gcc-13
            cxx: g++-13

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ${{ matrix.cc }} \
          ${{ matrix.cxx }} \
          gcc-12-plugin-dev \
          gcc-13-plugin-dev \
          clang \
          cmake \
          ninja-build

    - name: Configure CMake
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

    - name: Unit Tests
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure -L unit

    - name: Integration Tests
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure -L integration
      continue-on-error: true  # Integration tests may have some platform-specific issues

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-${{ matrix.compiler }}
        path: ${{github.workspace}}/build/Testing/

  benchmark:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 gcc-13-plugin-dev cmake ninja-build

    - name: Configure CMake
      env:
        CC: gcc-13
        CXX: g++-13
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DMORPHECT_BUILD_TESTS=OFF \
          -DMORPHECT_BUILD_BENCHMARKS=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Run Benchmarks
      working-directory: ${{github.workspace}}/build
      run: ./bin/morphect_bench --benchmark_format=json > benchmark_results.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: ${{github.workspace}}/build/benchmark_results.json

  coverage:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 gcc-13-plugin-dev cmake ninja-build lcov

    - name: Configure CMake with coverage
      env:
        CC: gcc-13
        CXX: g++-13
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_C_FLAGS="--coverage" \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build ${{github.workspace}}/build

    - name: Run tests
      working-directory: ${{github.workspace}}/build
      run: ctest --output-on-failure -L unit

    - name: Generate coverage report
      run: |
        lcov --capture --directory ${{github.workspace}}/build \
          --output-file coverage.info \
          --ignore-errors mismatch
        lcov --remove coverage.info '/usr/*' '*/build/_deps/*' \
          --output-file coverage.info \
          --ignore-errors unused
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.info
        fail_ci_if_error: false

  clang-format:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check formatting
      uses: jidicula/clang-format-action@v4.13.0
      with:
        clang-format-version: '17'
        check-path: 'src'
        fallback-style: 'LLVM'
      continue-on-error: true  # Don't fail CI on format issues, just report

  sanitizers:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # Only run UBSan - ASan has test discovery issues with gtest_discover_tests
          - sanitizer: undefined
            static_lib: -static-libubsan

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 gcc-13-plugin-dev cmake ninja-build

    - name: Configure CMake
      env:
        CC: gcc-13
        CXX: g++-13
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} ${{ matrix.static_lib }}" \
          -DCMAKE_C_FLAGS="-fsanitize=${{ matrix.sanitizer }} ${{ matrix.static_lib }}" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }} ${{ matrix.static_lib }}" \
          -DMORPHECT_BUILD_TESTS=ON \
          -DMORPHECT_BUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build ${{github.workspace}}/build

    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      working-directory: ${{github.workspace}}/build
      run: ctest --output-on-failure
      env:
        UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
