# Assembly Obfuscator

The `morphect-asm` tool provides post-compilation obfuscation for x86-64 assembly files.

---

## Contents

1. [Overview](#overview)
2. [Command Line Interface](#command-line-interface)
3. [Features](#features)
4. [Workflow](#workflow)
5. [Configuration](#configuration)
6. [Examples](#examples)
7. [Build System Integration](#build-system-integration)
8. [Limitations](#limitations)

---

## Overview

`morphect-asm` operates on assembly files generated by compilers, applying obfuscation transformations at the lowest level before final assembly. This approach complements the IR-level obfuscation tools by providing additional protection that operates after compiler optimizations.

Key characteristics:

- **Input Format:** x86-64 assembly in Intel syntax (GCC/Clang with `-masm=intel`)
- **Output Format:** Obfuscated assembly, compatible with standard assemblers
- **Platform:** Linux x86-64
- **Preservation:** Maintains functional correctness, CFI directives, and debug information structure

The assembly obfuscator is particularly useful for:

- Protecting code that cannot be compiled through LLVM or GCC plugin pipelines
- Adding an additional obfuscation layer on top of IR-level transformations
- Obfuscating hand-written assembly routines
- Post-processing third-party object code (when assembly is available)

---

## Command Line Interface

### Basic Usage

```bash
morphect-asm [options] <input.s> <output.s>
```

### Options

| Option | Description |
|--------|-------------|
| `--config <file>` | Load settings from JSON configuration file |
| `--probability <n>` | Global transformation probability (0.0-1.0), default 0.5 |
| `--verbose` | Enable detailed output showing transformation statistics |
| `--help` | Display usage information |

### Examples

```bash
# Basic obfuscation with default settings
morphect-asm input.s output.s

# Maximum obfuscation
morphect-asm --probability 1.0 input.s output.s

# With configuration file
morphect-asm --config obf_config.json input.s output.s

# Verbose output for debugging
morphect-asm --verbose --probability 0.8 input.s output.s
```

---

## Features

### Control Flow Obfuscation

**Opaque Predicates:** Inserts conditional branches with mathematically guaranteed outcomes that are difficult to determine through static analysis.

Implemented predicates:
- `(x & 1) == 0` for stack pointer (always true due to alignment)
- `(x | 1) != 0` (always true for any value)
- `x^2 >= 0` (squares are non-negative)
- `(x & x) == x` (identity property)
- `0 == 0` (trivially true, combined with complex setup)

Example transformation:
```asm
; Original
mov eax, DWORD PTR [rbp-4]

; With opaque predicate
lea rsp, [rsp - 128]        ; Red zone protection
pushfq                       ; Save flags
push r11
mov r11, rsp
test r11, 1                  ; Check alignment (always 0)
jnz .Lfake_path              ; Never taken
pop r11
jmp .Lreal_path
.Lfake_path:
pop r11
.byte 0x0f, 0x0b             ; Invalid instruction (ud2)
.Lreal_path:
popfq
lea rsp, [rsp + 128]
mov eax, DWORD PTR [rbp-4]   ; Original instruction
```

**Bogus Branches:** Inserts unconditional jumps through conditional branches that always evaluate the same way, adding unreachable code paths with junk bytes.

### Mixed Boolean Arithmetic (MBA)

Transforms simple arithmetic operations into mathematically equivalent but complex expressions:

```asm
; Original
sub eax, 1

; MBA transformation (one possibility)
add eax, -1

; Or using bitwise operations
; a - 1 = a + (~0) via two's complement properties
```

### Constant Obfuscation

Replaces immediate values with computed equivalents:

**XOR Method:**
```asm
; Original
mov edi, 5

; Obfuscated
mov edi, 0x5f4900
xor edi, 0x5f4905    ; Result: 5
```

**NOT Method:**
```asm
; Original
mov eax, 0

; Obfuscated
mov eax, 0xffffffff
not eax              ; Result: 0
```

**ADD Method:**
```asm
; Original
mov edi, 10

; Obfuscated
mov edi, 7
add edi, 3           ; Result: 10
```

### Dead Code Insertion

Adds computations that appear meaningful but do not affect program output:

```asm
; Inserted dead code block
xor rax, rax
mov rbx, 0xDEADBEEF
call rax             ; Would crash if reached
.byte 0xcc           ; Junk byte (int3)
```

The dead code is placed on unreachable paths created by bogus branches.

### Label Randomization

Replaces predictable label names with random strings:

```asm
; Original (GCC output)
.L1:
.L2:
.LFE0:

; Randomized
.LdjMhusYtL_1:
.LEBsQWIpeO_2:
.LqeFKtuBLB_3:
```

This prevents correlation between symbols and original structure.

### Prologue Obfuscation

Transforms function prologues while maintaining correctness:

```asm
; Original
push rbp
mov rbp, rsp
sub rsp, 16

; Obfuscated (using add with negative)
push rbp
mov rbp, rsp
add rsp, -16
```

---

## Workflow

The assembly obfuscator fits into the compilation pipeline as follows:

```
Source Code (.c/.cpp)
        |
        v
   Compiler (gcc -S -masm=intel)
        |
        v
 Assembly File (.s)
        |
        v
   morphect-asm
        |
        v
 Obfuscated Assembly (.s)
        |
        v
   Assembler (as/gcc)
        |
        v
  Object File (.o)
        |
        v
   Linker (ld/gcc)
        |
        v
  Executable
```

### Generating Compatible Assembly

The input assembly must use Intel syntax. Generate it with:

```bash
# GCC
gcc -S -masm=intel -o file.s file.c

# Clang
clang -S -masm=intel -o file.s file.c
```

### Complete Example

```bash
# 1. Compile to assembly
gcc -S -masm=intel -O2 -o program.s program.c

# 2. Obfuscate
morphect-asm --probability 0.8 program.s program_obf.s

# 3. Assemble and link
gcc program_obf.s -o program
```

---

## Configuration

### JSON Configuration File

```json
{
  "assembly": {
    "probability": 0.7,
    "control_flow": true,
    "mba": true,
    "constant_obfuscation": true,
    "dead_code": true,
    "label_randomization": true,
    "prologue_obfuscation": true,
    "string_encryption": false
  }
}
```

### Feature Toggles

| Feature | Description | Default |
|---------|-------------|---------|
| `control_flow` | Opaque predicates and bogus branches | Enabled |
| `mba` | Mixed Boolean Arithmetic transformations | Enabled |
| `constant_obfuscation` | Replace constants with computed values | Enabled |
| `dead_code` | Insert unreachable code paths | Enabled |
| `label_randomization` | Randomize internal label names | Enabled |
| `prologue_obfuscation` | Transform function prologues | Enabled |
| `string_encryption` | XOR-encrypt string literals | Disabled* |

*String encryption requires a runtime decryption routine and is disabled by default.

---

## Examples

### Factorial Function

**Original Assembly (excerpt):**
```asm
factorial:
    push    rbp
    mov     rbp, rsp
    sub     rsp, 16
    mov     DWORD PTR -4[rbp], edi
    cmp     DWORD PTR -4[rbp], 1
    jg      .L3
    mov     eax, 1
    jmp     .L4
.L3:
    mov     eax, DWORD PTR -4[rbp]
    sub     eax, 1
    mov     edi, eax
    call    factorial
    imul    eax, DWORD PTR -4[rbp]
.L4:
    leave
    ret
```

**Obfuscated Assembly (excerpt):**
```asm
factorial:
.LdjMhusYtL_11:
    .cfi_startproc
    push    rbp
    mov     rbp, rsp
    add rsp, -16                    ; Prologue obfuscation
    lea rsp, [rsp - 128]            ; Red zone protection
    pushfq
    push r11
    mov r11, rsp
    test r11, 1                     ; Opaque predicate
    jnz .LlkyAiPcSX_18
    pop r11
    jmp .LjUCbkQlfN_17
.LlkyAiPcSX_18:
    pop r11
    .byte 0x0f, 0x0b                ; Junk bytes (ud2)
.LjUCbkQlfN_17:
    popfq
    lea rsp, [rsp + 128]
    mov     DWORD PTR -4[rbp], edi
    ; ... continues with more obfuscation
```

### Integrating with IR Obfuscation

For maximum protection, combine with LLVM IR or GCC plugin obfuscation:

```bash
# Step 1: IR-level obfuscation
clang -emit-llvm -c program.c -o program.bc
morphect-ir --all program.bc program_ir.bc

# Step 2: Compile to assembly
llc -x86-asm-syntax=intel program_ir.bc -o program.s

# Step 3: Assembly-level obfuscation
morphect-asm --probability 0.8 program.s program_final.s

# Step 4: Final compilation
gcc program_final.s -o program
```

---

## Build System Integration

### Makefile

```makefile
CC = gcc
CFLAGS = -S -masm=intel -O2
MORPHECT_ASM = morphect-asm
MORPHECT_FLAGS = --probability 0.7

%.o: %.c
	$(CC) $(CFLAGS) -o $*.s $<
	$(MORPHECT_ASM) $(MORPHECT_FLAGS) $*.s $*_obf.s
	$(CC) -c $*_obf.s -o $@
```

### CMake

```cmake
function(obfuscate_assembly target)
    get_target_property(SOURCES ${target} SOURCES)
    foreach(source ${SOURCES})
        get_filename_component(name ${source} NAME_WE)
        set(asm_file "${CMAKE_CURRENT_BINARY_DIR}/${name}.s")
        set(obf_file "${CMAKE_CURRENT_BINARY_DIR}/${name}_obf.s")

        add_custom_command(
            OUTPUT ${obf_file}
            COMMAND ${CMAKE_C_COMPILER} -S -masm=intel -o ${asm_file} ${source}
            COMMAND morphect-asm --probability 0.7 ${asm_file} ${obf_file}
            DEPENDS ${source}
        )
        list(APPEND OBF_SOURCES ${obf_file})
    endforeach()

    add_executable(${target}_obf ${OBF_SOURCES})
endfunction()
```

---

## Limitations

### Platform Support

- **Architecture:** x86-64 only
- **Syntax:** Intel syntax only (not AT&T)
- **OS:** Linux (uses System V ABI conventions)

### Feature Limitations

**String Encryption:**
String encryption is available but disabled by default because it requires a runtime decryption routine to be linked. The obfuscated binary must include the decryption function, or strings will remain encrypted.

**CFI Directives:**
The obfuscator preserves CFI (Call Frame Information) directives for stack unwinding. However, heavily obfuscated functions may produce larger frame descriptions.

**Debug Information:**
While basic structure is preserved, extensive obfuscation may reduce debuggability. Consider using lower probability values during development.

### Compatibility Notes

- Works with GCC and Clang generated assembly
- Preserves `.cfi_*` directives for exception handling
- Handles PIE (Position Independent Executables) correctly
- Compatible with most system call conventions

---

*Previous: [GCC Plugin](04-gcc-plugin.md) | Next: [Obfuscation Techniques](06-techniques.md)*
